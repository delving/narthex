# Trends Capture & Aggregation Redesign

**Date**: 2026-02-19
**Status**: Approved

## Problem

The current trends implementation produces wrong counts and erratic deltas because:

1. **Zero-count midnight snapshots**: The daily job runs at midnight before harvests complete, recording `sourceRecords=0`. The delta then computes `realCount - 0 = realCount`, reporting the entire dataset as "new" every day.
2. **Bouncing counts during partial harvests**: `sourceRecordCount` temporarily drops mid-harvest, creating wild delta swings (e.g., -4670 one day, +4670 the next).
3. **Wrong delta baseline**: `calculateDeltaForWindow` compares `last - first` within a time window instead of `current - closestSnapshotBeforeWindow`.
4. **97% redundant snapshots**: Event snapshots fire even when nothing changed, bloating JSONL files.
5. **Missing sourceRecords**: 41 datasets have `sourceRecords=0` permanently because they were never re-harvested after trends were added.

### Data Evidence

Analysis of 359 datasets with 62,240 snapshot lines from the brabantcloud production server confirmed all five bugs. The zero-count midnight snapshot combined with the delta formula is the primary cause of "it says X new where that is the exact same as yesterday."

## Design

### Data Model: Two Files Per Dataset

**`trends.jsonl`** (event log, append-only):
- One line per processing run that changes record counts
- Only written when counts differ from the previous entry
- Fields:

```json
{
  "timestamp": "2026-02-19T14:30:00.000Z",
  "event": "harvest|save|manual",
  "sourceRecords": 90427,
  "acquiredRecords": 90427,
  "deletedRecords": 0,
  "validRecords": 90000,
  "invalidRecords": 427,
  "indexedRecords": 90000
}
```

**`trends-daily.jsonl`** (daily summaries, one line per day):
- Generated by nightly aggregation at 00:30
- Uses the last snapshot of the day as end-of-day counts
- Computes delta vs. previous day
- Fields:

```json
{
  "date": "2026-02-19",
  "endOfDay": {
    "sourceRecords": 90427,
    "acquiredRecords": 90427,
    "deletedRecords": 0,
    "validRecords": 90000,
    "invalidRecords": 427,
    "indexedRecords": 90000
  },
  "delta": {
    "source": 50,
    "valid": 48,
    "indexed": 48
  },
  "events": 3
}
```

### Capture Timing

**Event snapshots** (to `trends.jsonl`):
- After harvest completes (PMH, AdLib, JSON) -- only if `sourceRecordCount > 0`
- After SAVE completes
- Only if counts changed vs. the last entry in the file
- Guard: skip if `sourceRecords < previousSourceRecords * 0.5` (likely partial harvest)

**Daily aggregation** (to `trends-daily.jsonl`):
- Nightly job at 00:30 (replaces midnight snapshot)
- Reads last entry from `trends.jsonl` per dataset
- Computes delta vs. previous day's summary
- Regenerates org-level `trends_summary.json`

**Removed**: The midnight daily snapshot capture is eliminated (source of zero-count bug).

### Delta Calculation

For time windows (24h, 7d, 30d):
- Read `trends-daily.jsonl`
- Find the daily summary for N days ago (or closest available before that)
- Delta = current end-of-day counts - that day's end-of-day counts

For "since last run":
- Compare last two entries in `trends.jsonl`

### Frontend Changes

Minimal changes to existing trends page:
- Time windows pull from `trends-daily.jsonl` (more accurate)
- Add "since last run" indicator showing what changed in the most recent event
- Growing/shrinking/stable categorization uses clean daily deltas

### Migration

1. Keep existing `trends.jsonl` files (renamed to `trends-legacy.jsonl`)
2. Start fresh `trends.jsonl` capturing only change events
3. Generate initial `trends-daily.jsonl` from legacy data: pick last snapshot per day, compute daily deltas
4. Migration runs automatically on first nightly aggregation (detects missing `trends-daily.jsonl`)

## Files to Modify

- `app/services/TrendTrackingService.scala` -- Core logic: new capture guards, daily aggregation, delta calculation
- `app/dataset/DatasetContext.scala` -- Add `trendsDailyLog` file reference
- `app/dataset/DatasetActor.scala` -- Adjust event snapshot trigger (skip if unchanged)
- `app/organization/OrgContext.scala` -- Change scheduler from midnight capture to 00:30 aggregation
- `app/controllers/AppController.scala` -- Update API to read from daily summaries
- `app/assets/javascripts/trends/trends-controllers.js` -- Minor frontend adjustments
- `public/templates/trends.html` -- Add "since last run" column
