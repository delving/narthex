<!-- E -->
<div ng-if="!websocketConnected && !websocketError" class="alert alert-warning" style="margin: 15px 15px 0 15px;">
    <i class="fa fa-exclamation-triangle"></i> WebSocket disconnected. Reconnecting...
</div>
<div ng-if="websocketError" class="alert alert-danger" style="margin: 15px 15px 0 15px;">
    <i class="fa fa-times-circle"></i> {{websocketError}}
</div>

<div class="page-header no-margin">
    <!-- page location, org -->
    <div class="meta">
        <div class="page">Datasets</div>
        <div class="organization">
            <span class="fa fa-institution"></span>
            <span>{{ orgId }}</span>
        </div>
    </div>
    <!-- page specifiction actions/tools -->
    <div class="actions">
        <form action="" class="form-inline">
            <div class="form-group">
                <a href class="btn btn-default" data-ng-click="newFileOpen = true">
                    <i class="fa fa-star"></i> New Dataset
                </a>
                <a href class="btn btn-info" data-ng-click="openAllDatasets = !openAllDatasets">
                    <i class="fa fa-bars"></i> Open/Close All
                </a>
                <a href="#/index-stats" class="btn btn-default" style="position: relative;">
                    <i class="fa fa-bar-chart"></i> Index Stats
                    <span ng-if="indexStatsAlertCount > 0" class="badge"
                          style="position: absolute; top: -8px; right: -8px; background-color: #d9534f; color: white; font-size: 11px; padding: 3px 6px; border-radius: 10px;">
                        {{ indexStatsAlertCount }}
                    </span>
                </a>
                <a href="#/trends" class="btn btn-default">
                    <i class="fa fa-line-chart"></i> Trends
                </a>
            </div>
        </form>
    </div>
</div>

<div class="toolbar">
    <form class="form-inline">
        <div class="form-group">
            <span class="dropdown">
                <button id="order-button" type="button" class="btn btn-default" dropdown-toggle ng-disabled="disabled">
                    Order by <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" aria-labelledby="single-button">
                    <li role="menuitem">
                        <a href data-ng-click="datasetListOrder('spec')">Spec</a>
                    </li>
                    <li role="menuitem">
                        <a href data-ng-click="datasetListOrder('state')">State</a>
                    </li>
                    <li role="menuitem">
                        <a href data-ng-click="datasetListOrder('lastmodified')">Date last modified</a>
                    </li>
                </ul>
            </span>
        </div>
        <div class="form-group">
            <div class="dropdown">
                <button id="state-filter-button" type="button" class="btn btn-default" dropdown-toggle
                    ng-disabled="disabled">
                    Filter by state <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" aria-labelledby="single-button">
                    <li data-ng-repeat="state in datasetStates" role="menuitem">
                        <a href data-ng-click="setStateFilter(state.name)">{{ state.label }} ({{ state.count }})</a>
                    </li>
                    <li role="menuitem">
                        <a href data-ng-click="stateFilter = ''">Reset</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="form-group">
            <input type="text" class="form-control" data-ng-model="specOrNameFilter"
                placeholder="Filter by Spec or Name" />
        </div>
        <div class="form-group pull-right">
            <div class="btn-group">
                <button type="button" class="btn"
                        ng-class="{'btn-primary': stateFilter === 'stateActive', 'btn-default': stateFilter !== 'stateActive'}"
                        ng-click="stateFilter === 'stateActive' ? stateFilter = '' : setStateFilter('stateActive')">
                    <i class="fa fa-cog" ng-class="{'fa-spin': activeDatasets.total > 0}"></i>
                    {{ activeDatasets.total }} active
                </button>
                <button type="button" class="btn"
                        ng-class="{'btn-success': stateFilter === 'stateWorking', 'btn-default': stateFilter !== 'stateWorking'}"
                        ng-click="stateFilter === 'stateWorking' ? stateFilter = '' : setStateFilter('stateWorking')"
                        ng-if="activeDatasets.processing.length + activeDatasets.saving.length > 0">
                    <i class="fa fa-play"></i>
                    {{ activeDatasets.processing.length + activeDatasets.saving.length }} working
                </button>
                <button type="button" class="btn"
                        ng-class="{'btn-info': stateFilter === 'stateQueued', 'btn-default': stateFilter !== 'stateQueued'}"
                        ng-click="stateFilter === 'stateQueued' ? stateFilter = '' : setStateFilter('stateQueued')"
                        ng-if="activeDatasets.queued.length > 0">
                    <i class="fa fa-clock-o"></i>
                    {{ activeDatasets.queued.length }} queued
                </button>
                <button type="button" class="btn btn-default"
                        ng-click="toggleStatsPanel()"
                        title="Show completion statistics">
                    <i class="fa fa-bar-chart"></i>
                    <span ng-if="showStatsPanel"><i class="fa fa-caret-up"></i></span>
                    <span ng-if="!showStatsPanel"><i class="fa fa-caret-down"></i></span>
                </button>
            </div>
        </div>
    </form>

    <!-- Completion Stats Panel -->
    <div ng-if="showStatsPanel" class="panel panel-default" style="margin-top: 10px; margin-bottom: 0;">
        <div class="panel-heading" style="padding: 8px 15px;">
            <strong><i class="fa fa-check-circle"></i> Completed (Saved)</strong>
            <button class="btn btn-xs btn-default pull-right" ng-click="refreshStats()" title="Refresh stats">
                <i class="fa fa-refresh"></i>
            </button>
        </div>
        <div class="panel-body" style="padding: 10px 15px;">
            <table class="table table-condensed table-striped" style="margin-bottom: 0;">
                <thead>
                    <tr>
                        <th></th>
                        <th class="text-center">Manual</th>
                        <th class="text-center">Automatic</th>
                        <th class="text-center">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Last 1h</strong></td>
                        <td class="text-center">{{ completionStats.manual1h || 0 }}</td>
                        <td class="text-center">{{ completionStats.automatic1h || 0 }}</td>
                        <td class="text-center"><strong>{{ (completionStats.manual1h || 0) + (completionStats.automatic1h || 0) }}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Last 4h</strong></td>
                        <td class="text-center">{{ completionStats.manual4h || 0 }}</td>
                        <td class="text-center">{{ completionStats.automatic4h || 0 }}</td>
                        <td class="text-center"><strong>{{ (completionStats.manual4h || 0) + (completionStats.automatic4h || 0) }}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Last 24h</strong></td>
                        <td class="text-center">{{ completionStats.manual24h || 0 }}</td>
                        <td class="text-center">{{ completionStats.automatic24h || 0 }}</td>
                        <td class="text-center"><strong>{{ (completionStats.manual24h || 0) + (completionStats.automatic24h || 0) }}</strong></td>
                    </tr>
                </tbody>
            </table>
            <!-- Summary and link to full stats page -->
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;" class="clearfix">
                <span class="text-muted">
                    <strong>{{ completionDetails.length || 0 }}</strong> operations,
                    <strong>{{ uniqueDatasets24h || 0 }}</strong> unique datasets
                </span>
                <a href="#/stats" class="btn btn-xs btn-default pull-right">
                    <i class="fa fa-bar-chart"></i> View Details
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Active Filter Breadcrumbs -->
<div class="active-filters" ng-if="hasActiveFilters()"
     style="margin: 10px 15px; padding: 10px 15px; background-color: #f5f5f5; border-radius: 4px;">
    <span style="font-weight: bold; margin-right: 10px; color: #333;">Active filters:</span>

    <!-- Order By Breadcrumb -->
    <span ng-if="currentSortOrder && currentSortOrder !== 'spec'"
          class="label label-info" style="margin-right: 5px; font-size: 13px; padding: 5px 8px;">
        Order: {{ getOrderLabel(currentSortOrder) }}
        <a href ng-click="clearOrderFilter()" style="color: white; margin-left: 5px;" title="Remove filter">
            <i class="fa fa-times-circle"></i>
        </a>
    </span>

    <!-- State Filter Breadcrumb -->
    <span ng-if="stateFilter"
          class="label label-info" style="margin-right: 5px; font-size: 13px; padding: 5px 8px;">
        State: {{ getStateLabel(stateFilter) }}
        <a href ng-click="clearStateFilter()" style="color: white; margin-left: 5px;" title="Remove filter">
            <i class="fa fa-times-circle"></i>
        </a>
    </span>

    <!-- Spec/Name Filter Breadcrumb -->
    <span ng-if="specOrNameFilter"
          class="label label-info" style="margin-right: 5px; font-size: 13px; padding: 5px 8px;">
        Search: "{{ specOrNameFilter }}"
        <a href ng-click="clearSpecFilter()" style="color: white; margin-left: 5px;" title="Remove filter">
            <i class="fa fa-times-circle"></i>
        </a>
    </span>

    <!-- Clear All Button -->
    <a href ng-click="clearAllFilters()" class="btn btn-xs btn-default" style="margin-left: 10px;">
        <i class="fa fa-times"></i> Clear all filters
    </a>
</div>

<div class="file-list datasets">
    <div data-ng-if="!datasets.length" class="col-md-12">
        <h4>No datasets</h4>
    </div>
    <table class="dataset-list-table">
        <thead>
            <tr>
                <th class="spec">Spec</th>
                <th class="name">Display name</th>
                <th class="acquired" title="Acquired records (harvested or uploaded) and deleted count">Acquired</th>
                <th class="source" title="Source records (valid/invalid after processing)">Source</th>
                <th class="trend" title="24h change in indexed records">Trend</th>
                <th class="activity">Activity</th>
                <th class="status">Status</th>
                <th class="date-time">Last changed</th>
            </tr>
        </thead>
    </table>
    <div class="vertical-scroll" data-scrollable id="dataset-list" data-offset="160">
        <div ng-repeat="dataset in datasets | filter: datasetVisibleFilter" class="" id="dataset-{{ dataset.datasetSpec }}">
            <div data-ng-controller="DatasetEntryCtrl">
                <table class="dataset-list-table">
                    <tbody>
                        <tr data-spec="{{ dataset.datasetSpec }}"
                            data-ng-click="expanded = !expanded; expandDataset(dataset)"
                            class="clickable"
                            data-ng-class="{ 'closed': !expanded, 'open': expanded }"
                            style="{{dataset.isActive ? 'background-color: #f0f8ff; border-left: 3px solid #337ab7;' : (dataset.isQueued ? 'background-color: #fff8e6; border-left: 3px solid #f0ad4e;' : '')}}">
                            <td class="spec">
                                <span class="spec-field">{{ dataset.datasetSpec }}
                                    <i data-ng-show="dataset.isActive || dataset.progress" class="fa fa-spinner fa-pulse fa-1x fa-fw" title="Processing or saving"></i>
                                </span>
                            </td>
                            <td class="name">
                                <span data-ng-show="dataset.datasetName" class="name-field">{{ dataset.datasetName
                                    }}</span>
                            </td>
                            <td class="acquired"
                                title="Acquired: {{ dataset.acquiredRecordCount || dataset.datasetRecordCount || 0 }}&#10;Deleted: {{ dataset.deletedRecordCount || 0 }}&#10;Source: {{ dataset.sourceRecordCount || (dataset.acquiredRecordCount || dataset.datasetRecordCount || 0) - (dataset.deletedRecordCount || 0) }}">
                                <!-- Acquisition method icon -->
                                <i data-ng-if="dataset.acquisitionMethod == 'harvest'" class="fa fa-download text-info" title="Harvested via OAI-PMH"></i>
                                <i data-ng-if="dataset.acquisitionMethod == 'upload'" class="fa fa-upload text-muted" title="Uploaded file"></i>
                                <!-- Acquired count -->
                                <span data-ng-if="dataset.acquiredRecordCount">{{ dataset.acquiredRecordCount }}</span>
                                <span data-ng-if="!dataset.acquiredRecordCount && dataset.datasetRecordCount">{{ dataset.datasetRecordCount }}</span>
                                <span data-ng-if="!dataset.acquiredRecordCount && !dataset.datasetRecordCount">-</span>
                                <!-- Deleted count (if any) -->
                                <span data-ng-if="dataset.deletedRecordCount > 0" class="text-warning" title="Deleted records in OAI-PMH">
                                    (-{{ dataset.deletedRecordCount }})
                                </span>
                            </td>
                            <td class="source"
                                title="Valid: {{ dataset.harvestIncrementalMode == 'true' ? (dataset.processedIncrementalValid || 0) : (dataset.processedValid || 0) }}&#10;Invalid: {{ dataset.harvestIncrementalMode == 'true' ? (dataset.processedIncrementalInvalid || 0) : (dataset.processedInvalid || 0) }}">
                                <!-- Valid count (primary) -->
                                <span data-ng-if="dataset.harvestIncrementalMode == 'true'" class="text-success">
                                    {{ dataset.processedIncrementalValid || '-' }}
                                </span>
                                <span data-ng-if="!dataset.harvestIncrementalMode || dataset.harvestIncrementalMode == 'false'" class="text-success">
                                    {{ dataset.processedValid || '-' }}
                                </span>
                                <!-- Invalid count (if any) -->
                                <span data-ng-if="dataset.harvestIncrementalMode == 'true' && dataset.processedIncrementalInvalid > 0" class="text-danger">
                                    /{{ dataset.processedIncrementalInvalid }}
                                </span>
                                <span data-ng-if="(!dataset.harvestIncrementalMode || dataset.harvestIncrementalMode == 'false') && dataset.processedInvalid > 0" class="text-danger">
                                    /{{ dataset.processedInvalid }}
                                </span>
                                <!-- Incremental indicator -->
                                <span data-ng-if="dataset.harvestIncrementalMode == 'true'" class="text-muted" style="font-size: 0.8em;">(inc)</span>
                            </td>
                            <td class="trend" title="24h: source {{ dataset.trend24h.source >= 0 ? '+' : '' }}{{ dataset.trend24h.source }}, indexed {{ dataset.trend24h.indexed >= 0 ? '+' : '' }}{{ dataset.trend24h.indexed }}">
                                <!-- Trend indicator for indexed records -->
                                <span data-ng-if="dataset.trend24h.indexed > 0" class="text-success">
                                    <i class="fa fa-arrow-up"></i> +{{ dataset.trend24h.indexed }}
                                </span>
                                <span data-ng-if="dataset.trend24h.indexed < 0" class="text-danger">
                                    <i class="fa fa-arrow-down"></i> {{ dataset.trend24h.indexed }}
                                </span>
                                <span data-ng-if="!dataset.trend24h || dataset.trend24h.indexed == 0" class="text-muted">
                                    -
                                </span>
                            </td>
                            <td class="activity">
                                <!-- Processing status with cancel button -->
                                <span data-ng-if="dataset.isProcessing" class="label label-primary">
                                    <i class="fa fa-cog fa-spin"></i> PROCESSING
                                    <button type="button" class="btn btn-xs btn-link" style="padding: 0 5px; color: white;"
                                            data-ng-click="interruptOperation(dataset.datasetSpec); $event.stopPropagation();"
                                            title="Interrupt processing">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </span>
                                <!-- Saving status with cancel button -->
                                <span data-ng-if="dataset.isSaving" class="label label-info">
                                    <i class="fa fa-save"></i> SAVING
                                    <button type="button" class="btn btn-xs btn-link" style="padding: 0 5px; color: white;"
                                            data-ng-click="interruptOperation(dataset.datasetSpec); $event.stopPropagation();"
                                            title="Interrupt saving">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </span>
                                <!-- Queued status with position, trigger, and cancel button -->
                                <span data-ng-if="dataset.isQueued" class="label label-warning">
                                    <i class="fa fa-hourglass-half"></i>
                                    QUEUED #{{ dataset.queuePosition }}
                                    <span ng-if="dataset.activityTrigger === 'periodic'">(auto)</span>
                                    <span ng-if="dataset.activityTrigger === 'manual'">(manual)</span>
                                    <span ng-if="dataset.activityTrigger === 'recovery'">(recovery)</span>
                                    <button type="button" class="btn btn-xs btn-link" style="padding: 0 5px; color: white;"
                                            data-ng-click="cancelQueuedOperation(dataset.datasetSpec); $event.stopPropagation();"
                                            title="Cancel queued operation">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </span>
                                <!-- Retry indicator -->
                                <span data-ng-if="dataset.inRetry && !dataset.isProcessing && !dataset.isSaving && !dataset.isQueued" class="label label-warning" title="{{ dataset.retryMessage }}">
                                    <i class="fa fa-clock-o"></i> RETRY #{{ dataset.retryCount }} in {{ dataset.nextRetryMinutes }}m
                                </span>
                                <!-- Idle indicator -->
                                <span data-ng-if="!dataset.isProcessing && !dataset.isSaving && !dataset.isQueued && !dataset.inRetry" class="text-muted">
                                    <i class="fa fa-minus"></i>
                                </span>
                            </td>
                            <td class="status">
                                <span ng-switch="dataset.stateCurrent.name" class="indicator" data-ng-class="{stateEmpty:'empty',
                                            stateRaw: 'raw',
                                            stateRawAnalyzed: 'raw-analyzed',
                                            stateSourced: 'sourced',
                                            stateSourceAnalyzed: 'source-analyzed',
                                            stateMappable: 'mappable',
                                            stateInError:'error',
                                            stateProcessable:'processable',
                                            stateIncrementalSaved: 'incremental-saved',
                                            stateProcessed: 'processed',
                                            stateAnalyzed: 'analyzed',
                                            stateSaved:'saved',
                                            stateDisabled:'disabled',
                                            stateReadyToHarvest:'ready-to-harvest',
                                            '':'default'}[dataset.stateCurrent.name]">
                                    <span ng-switch-when="stateRaw">Raw source</span>
                                    <span ng-switch-when="stateRawAnalyzed">Raw source analyzed</span>
                                    <span ng-switch-when="stateSourced">Sourced</span>
                                    <span ng-switch-when="stateSourceAnalyzed">Source analyzed</span>
                                    <span ng-switch-when="stateMappable">Mappable</span>
                                    <span ng-switch-when="stateProcessable">Processable</span>
                                    <span ng-switch-when="stateIncrementalSaved">Incremental Processed</span>
                                    <span ng-switch-when="stateInError">Processing error</span>
                                    <span ng-switch-when="stateProcessed">Processed</span>
                                    <span ng-switch-when="stateAnalyzed">Analyzed</span>
                                    <span ng-switch-when="stateSaved">Saved</span>
                                    <span ng-switch-when="stateDisabled">Disabled</span>
                                    <span ng-switch-when="stateReadyToHarvest">Ready to Harvest</span>
                                    <span ng-switch-default>Empty</span>
                                </span>
                            </td>
                            <td class="date-time">
                                {{ dataset.stateCurrent.date | date: 'yyyy/MM/dd HH:mm' }}
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div ng-if="expanded" class="dataset-metadata"
                    data-ng-class="{ 'closed': !expanded, 'expanded': expanded }">
                    <div class="dataset-states col-md-3">
                        <ul class="list-group states">
                            <li data-ng-show="dataset.stateRaw" class="ds-state list-group-item"
                                data-ng-class="{ 'later': isCurrent('stateRaw') }">
                                <h4 class="list-group-item-heading">
                                    Raw
                                    <small class="badge">{{ dataset.stateRaw.d }} {{
                                        dataset.stateRaw.t }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <a href data-ng-click="start('start raw analysis')">
                                        <i class="fa fa-fw fa-bar-chart"></i>
                                        <span>Analyze</span>
                                    </a>
                                </div>
                            </li>
                            <li data-ng-show="dataset.stateRawAnalyzed" class="ds-state list-group-item"
                                data-ng-class="{ 'later': isCurrent('stateRawAnalyzed') }">
                                <h4 class="list-group-item-heading">
                                    Raw Analyzed
                                    <small class="badge">{{ dataset.stateRawAnalyzed.d }} {{
                                        dataset.stateRawAnalyzed.t | date:
                                        'HH:mm' }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <a href data-ng-click="goToDataset()" data-ng-if="!dataset.delimitersValid">
                                        <i class="fa fa-fw fa-eye"></i>
                                        <span>Delimit</span>
                                    </a>
                                    <a href data-ng-click="start('start first harvest', 'Erase existing data, including records from the triple-store?')" data-ng-if="dataset.delimitersValid">
                                        <i class="fa fa-fw fa-download"></i>
                                        <span>Start Harvest</span>
                                    </a>
                                </div>
                            </li>
                            <!-- Ready to harvest: delimiters set but no state yet (PMH datasets after config) -->
                            <li data-ng-show="dataset.delimitersValid && !dataset.stateRawAnalyzed && !dataset.stateSourced" class="ds-state list-group-item"
                                data-ng-class="{ 'later': true }">
                                <h4 class="list-group-item-heading">
                                    Ready to Harvest
                                    <small class="badge">{{ dataset.delimitersSet | date: 'dd-MM' }} {{
                                        dataset.delimitersSet | date: 'HH:mm' }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <a href data-ng-click="start('start first harvest', 'Erase existing data, including records from the triple-store?')">
                                        <i class="fa fa-fw fa-download"></i>
                                        <span>Start Harvest</span>
                                    </a>
                                </div>
                            </li>
                            <li data-ng-show="dataset.stateSourced" class="ds-state list-group-item"
                                data-ng-class="{ 'later': isCurrent('stateSourced') }">
                                <h4 class="list-group-item-heading">
                                    Sourced
                                    <small class="badge">{{ dataset.stateSourced.d }} {{
                                        dataset.stateSourced.t }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <a href data-ng-click="start('start source analysis')">
                                        <i class="fa fa-fw fa-bar-chart"></i>
                                        <span>Analyze Source</span>
                                    </a>
                                    <a href data-ng-click="start('start generating sip')">
                                        <i class="fa fa-fw fa-cube"></i>
                                        <span>Make SIP</span>
                                    </a>
                                    <a href data-ng-click="fastSave(dataset, 'stateSourced')" ng-disabled="dataset.isActive || datasetBusy">
                                        <i class="fa fa-fw fa-bolt"></i>
                                        <span>Fast Save</span>
                                    </a>
                                </div>
                            </li>
                            <li data-ng-show="dataset.stateSourceAnalyzed" class="ds-state list-group-item"
                                data-ng-class="{ 'later': isCurrent('stateSourceAnalyzed') }">
                                <h4 class="list-group-item-heading">
                                    Source Analyzed
                                    <small class="badge">{{ dataset.stateSourceAnalyzed.d }} {{
                                        dataset.stateSourceAnalyzed.t }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <a href data-ng-click="viewSourceAnalysis(dataset)">
                                        <i class="fa fa-fw fa-sitemap"></i>
                                        <span>View Source Tree</span>
                                    </a>
                                    <a href data-ng-click="start('start source analysis')">
                                        <i class="fa fa-fw fa-refresh"></i>
                                        <span>Re-analyze</span>
                                    </a>
                                </div>
                            </li>
                            <li data-ng-show="dataset.stateMappable" class="ds-state list-group-item"
                                data-ng-class="{ 'later': isCurrent('stateMappable') }">
                                <h4 class="list-group-item-heading">
                                    Mappable
                                    <small class="badge">{{ dataset.stateMappable.d }} {{
                                        dataset.stateMappable.t }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <a href="#/sip-creator" id="nav-mapper">
                                        <i class="fa fa-fw fa-download"></i>
                                        Download the mapping tool
                                    </a>
                                </div>
                            </li>
                            <li data-ng-show="dataset.stateProcessable" class="ds-state list-group-item"
                                data-ng-class="{ 'later': isCurrent('stateProcessable') }">
                                <h4 class="list-group-item-heading">
                                    Processable
                                    <small class="badge">{{ dataset.stateProcessable.d }} {{
                                        dataset.stateProcessable.t }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <a href data-ng-click="start('start processing')">
                                        <i class="fa fa-fw fa-cogs"></i>
                                        <span>Process</span>
                                    </a>
                                    <a href data-ng-click="fastSave(dataset, 'stateProcessable')" ng-disabled="dataset.isActive || datasetBusy">
                                        <i class="fa fa-fw fa-bolt"></i>
                                        <span>Fast Save</span>
                                    </a>
                                </div>
                            </li>
                            <li data-ng-show="dataset.stateIncrementalSaved && dataset.harvestIncrementalMode"
                                class="ds-state list-group-item"
                                data-ng-class="{ 'later': isCurrent('stateIncrementalSaved') }">
                                <h4 class="list-group-item-heading">
                                    Incremental Saved
                                    <small class="badge">{{ dataset.stateIncrementalSaved.d }}
                                        {{ dataset.stateIncrementalSaved.t
                                        }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <a href data-ng-click="start('start processed analysis')">
                                        <i class="fa fa-fw fa-bar-chart"></i>
                                        <span>Analyze</span>
                                    </a>
                                </div>
                            </li>
                            <!-- todo add incremental mode back && !dataset.harvestIncrementalMode   -->
                            <li data-ng-show="dataset.stateProcessed" class="ds-state list-group-item"
                                data-ng-class="{ 'later': isCurrent('stateProcessed') }">
                                <h4 class="list-group-item-heading">
                                    Processed
                                    <small class="badge">{{ dataset.stateProcessed.d }} {{
                                        dataset.stateProcessed.t }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <a href data-ng-click="start('start processed analysis')">
                                        <i class="fa fa-fw fa-bar-chart"></i>
                                        <span>Analyze</span>
                                    </a>
                                    <a href data-ng-click="fastSave(dataset, 'stateProcessed')" ng-disabled="dataset.isActive || datasetBusy">
                                        <i class="fa fa-fw fa-bolt"></i>
                                        <span>Fast Save</span>
                                    </a>
                                </div>
                            </li>
                            <li data-ng-show="dataset.stateAnalyzed " class="ds-state list-group-item"
                                data-ng-class="{ 'later': isCurrent('stateAnalyzed') }">
                                <h4 class="list-group-item-heading">
                                    Analyzed
                                    <small class="badge">{{ dataset.stateAnalyzed.d }} {{
                                        dataset.stateAnalyzed.t }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <a href data-ng-click="goToDataset()">
                                        <i class="fa fa-fw fa-language"></i>
                                        <span>Explore</span>
                                    </a>
                                    <br />
                                    <!-- TODO: enable when process and save are folded together -->
                                    <!--<a href="{{ sparqlPath }}">-->
                                    <!--<i class="fa fa-fw fa-eye"></i>-->
                                    <!--<span>View saved RDF</span>-->
                                    <!--</a><br/>-->
                                    <!--<a href data-ng-click="goToTerms()" data-ng-if="dataset.skosField">-->
                                    <!--<i class="fa fa-fw fa-magic"></i> <span>Map vocabulary terms</span>-->
                                    <!--</a>-->
                                    <a href data-ng-click="start('start saving')">
                                        <i class="fa fa-fw fa-database"></i>
                                        <span>Save</span>
                                    </a>
                                    <a href data-ng-click="fastSave(dataset, 'stateAnalyzed')" ng-disabled="dataset.isActive || datasetBusy">
                                        <i class="fa fa-fw fa-bolt"></i>
                                        <span>Fast Save</span>
                                    </a>
                                </div>
                            </li>
                            <!--todo: hide this when bulk is enabled -->
                            <li data-ng-show="dataset.stateSaved" class="ds-state list-group-item"
                                data-ng-class="{ 'later': isCurrent('stateSaved') }">
                                <h4 class="list-group-item-heading">
                                    Saved
                                    <small class="badge">{{ dataset.stateSaved.d }} {{
                                        dataset.stateSaved.t }}</small>
                                </h4>
                                <div class="btn-toolbar">
                                    <div class="btn-toolbar">
                                        <a href="{{ sparqlPath }}">
                                            <i class="fa fa-fw fa-eye"></i>
                                            <span>View saved RDF</span>
                                        </a>
                                        <br />
                                        <a href data-ng-click="goToTerms()" data-ng-if="dataset.skosField">
                                            <i class="fa fa-fw fa-magic"></i>
                                            <span>Map vocabulary terms</span>
                                        </a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-9 dataset-forms">
                        <div data-ng-if="dataset.progress" class="ds-progress">
                            <div class="input-group">
                                <progressbar class="form-control-feedback progress-striped"
                                    ng-class="{'active': dataset.progress.count === 0}"
                                    value="dataset.progress.count" max="100">{{ dataset.progress.message }}
                                </progressbar>
                                <!-- Page/record metadata -->
                                <span class="input-group-addon" style="background: #f5f5f5; font-size: 11px; min-width: 100px;"
                                      data-ng-if="dataset.progress.currentPage || dataset.progress.currentRecords">
                                    <span data-ng-if="dataset.progress.currentPage">
                                        pg {{ dataset.progress.currentPage }}<span data-ng-if="dataset.progress.totalPages">/{{ dataset.progress.totalPages }}</span>
                                    </span>
                                    <span data-ng-if="dataset.progress.currentPage && dataset.progress.currentRecords"> | </span>
                                    <span data-ng-if="dataset.progress.currentRecords">
                                        {{ dataset.progress.currentRecords }}<span data-ng-if="dataset.progress.totalRecords">/{{ dataset.progress.totalRecords }}</span> rec
                                    </span>
                                </span>
                                <div class="input-group-btn">
                                    <button class="btn btn-danger btn-xs" data-ng-click="interruptProcessing(file)"
                                        data-ng-show="dataset.progress">
                                        <i class="fa fa-trash-o"></i>
                                        <span>Cancel</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Error recovery info box -->
                        <div data-ng-if="dataset.progress.errorRecoveryUrl" class="alert alert-info"
                             role="alert" style="margin-top: 5px; font-size: 12px;">
                            <i class="fa fa-wrench"></i>
                            <strong>Error recovery</strong> - A harvest page failed, recovering individual records
                            <br/>
                            <small class="text-muted">
                                Failed URL: {{ dataset.progress.errorRecoveryUrl }}
                                <br/>
                                Records recovered: {{ dataset.progress.errorPagesRecovered || 0 }} / {{ dataset.progress.errorPagesTotal || '?' }}
                            </small>
                        </div>

                        <!-- Retry status indicator (non-blocking) -->
                        <div data-ng-if="dataset.inRetry" class="alert alert-warning" role="alert">
                            <div class="pull-right btn-group">
                                <button type="button" class="btn btn-xs btn-primary"
                                        data-ng-click="retryNow()"
                                        data-ng-disabled="datasetBusy">
                                    <i class="fa fa-refresh"></i> Retry Now
                                </button>
                                <button type="button" class="btn btn-xs btn-default"
                                        data-ng-click="stopRetrying()">
                                    <i class="fa fa-stop"></i> Stop Retrying
                                </button>
                            </div>
                            <i class="fa fa-clock-o"></i>
                            <strong>Harvest failed</strong> -
                            Retrying in <span class="badge">{{ dataset.nextRetryMinutes }}</span> minutes
                            (attempt #{{ dataset.retryCount }})
                            <br/>
                            <small class="text-muted">{{ dataset.retryMessage }}</small>
                        </div>

                        <!-- Permanent error (blocking, requires dismissal) -->
                        <div data-ng-if="(dataset.datasetErrorMessage || dataset.errorMessage) && !dataset.inRetry">
                            <div class="alert alert-danger" role="alert">
                                <button type="button" class="close" data-dismiss="alert" data-ng-click="clearError()"
                                    aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <i class="fa fa-exclamation-circle"></i>
                                <span>{{ dataset.datasetErrorMessage || dataset.errorMessage | unsafe
                                    }}</span>
                                <hr />
                                You must
                                <a href data-dismiss="alert" data-ng-click="clearError()"
                                    class="alert-link">close/clear</a>
                                this error message to continue
                            </div>
                        </div>

                        <h4 data-ng-show="dataset.metadata.name">
                            <span>"{{ dataset.metadata.name | unsafe }}"</span>
                            <span data-ng-show="dataset.metadata.dataProvider">from "{{ dataset.metadata.dataProvider
                                }}":
                            </span>
                        </h4>

                        <div class="row">
                            <div class="tabbable dataset-tabs col-md-6">
                                <ul class="nav nav-pills" role="tablist">
                                    <li ng-class="{'active':leftTabOpen === 'metadata'}">
                                        <a href role="tab" data-ng-click="leftTabOpen = 'metadata'">Metadata</a>
                                    </li>
                                    <!-- <li ng-class="{'active':leftTabOpen === 'publication'}">
                                        <a href role="tab" data-ng-click="leftTabOpen = 'publication'">Publication</a>
                                    </li> -->
                                    <!--<li ng-class="{'active':leftTabOpen === 'categories'}">-->
                                    <!--<a href role="tab" data-ng-click="leftTabOpen ='categories'">Categories</a>-->
                                    <!--</li>-->
                                    <li data-ng-class="{'active':leftTabOpen === 'harvesting'}">
                                        <a href role="tab" data-ng-click="leftTabOpen = 'harvesting'">Harvesting</a>
                                    </li>
                                    <li data-ng-class="{'active':leftTabOpen === 'check-links'}">
                                        <a href role="tab" data-ng-click="leftTabOpen ='check-links'">Links</a>
                                    </li>
                                    <li data-ng-class="{'active':leftTabOpen === 'activity'}">
                                        <a href role="tab" data-ng-click="leftTabOpen = 'activity'">Activity</a>
                                    </li>
                                    <li data-ng-class="{'active':leftTabOpen === 'mapping'}">
                                        <a href role="tab" data-ng-click="setLeftTab('mapping')">Mapping</a>
                                    </li>
                                </ul>

                                <div class="tab-content clearfix">
                                    <div ng-switch="leftTabOpen">
                                        <div ng-switch-when="metadata">
                                            <div data-ng-include="'dataset-metadata-form.html'">
                                                metadata form
                                            </div>
                                        </div>
                                        <!-- <div ng-switch-when="publication">
                                            <div data-ng-include="'publication-form.html'">publication form</div>
                                        </div> -->
                                        <!--<div ng-switch-when="categories">-->
                                        <!--<div data-ng-include="'categories-form.html'">categories form</div>-->
                                        <!--</div>-->
                                        <div ng-switch-when="check-links">
                                            <div data-ng-include="'check-links.html'">
                                                check links
                                            </div>
                                        </div>
                                        <div ng-switch-when="harvesting">
                                            <div data-ng-include="'harvesting-info.html'">
                                                harvesting statistics
                                            </div>
                                        </div>
                                        <div ng-switch-when="activity">
                                            <div class="panel panel-default">
                                                <div class="panel-body">
                                                    <h4><i class="fa fa-history"></i> Activity History</h4>
                                                    <p>View detailed history of all operations performed on this dataset.</p>
                                                    <button class="btn btn-primary" ng-click="openActivityModal()">
                                                        <i class="fa fa-list-alt"></i> View Activity Log
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div ng-switch-when="mapping">
                                            <div class="panel panel-default">
                                                <div class="panel-body">
                                                    <div class="clearfix">
                                                        <h4 class="pull-left" style="margin-top: 0;"><i class="fa fa-map"></i> Mapping Source</h4>
                                                        <button class="btn btn-sm btn-info pull-right" ng-click="previewCurrentMapping()"
                                                                ng-disabled="!hasAnyMapping()"
                                                                title="Preview the current mapping XML (uploaded or default)">
                                                            <i class="fa fa-eye"></i> Preview Mapping
                                                        </button>
                                                    </div>
                                                    <p class="text-muted" ng-if="datasetSchemaPrefix">
                                                        <small>Schema prefix: <strong>{{ datasetSchemaPrefix | uppercase }}</strong></small>
                                                    </p>

                                                    <!-- Mapping Source Selection (only shown when default mappings feature is enabled) -->
                                                    <div class="form-group" ng-if="$root.enableDefaultMappings">
                                                        <div class="radio">
                                                            <label>
                                                                <input type="radio" name="mappingSource_{{ dataset.datasetSpec }}" value="manual"
                                                                       ng-model="mapping.source" ng-change="updateMappingSource()">
                                                                <strong>Manual</strong> - Use this dataset's own mapping (from SIP uploads)
                                                            </label>
                                                        </div>
                                                        <div class="radio">
                                                            <label>
                                                                <input type="radio" name="mappingSource_{{ dataset.datasetSpec }}" value="default"
                                                                       ng-model="mapping.source" ng-change="updateMappingSource()">
                                                                <strong>Default Mapping</strong> - Use a shared organization-wide mapping
                                                            </label>
                                                        </div>
                                                    </div>

                                                    <!-- Default Mapping Selection (shown when "default" is selected and feature is enabled) -->
                                                    <div ng-if="$root.enableDefaultMappings && mapping.source === 'default'" class="panel panel-info">
                                                        <div class="panel-heading">
                                                            <h5 class="panel-title">Select Default Mapping</h5>
                                                        </div>
                                                        <div class="panel-body">
                                                            <!-- Show message when no default mappings are available -->
                                                            <div ng-if="mapping.defaultMappings.length === 0" class="alert alert-warning">
                                                                <i class="fa fa-info-circle"></i> No default mappings available for
                                                                <strong>{{ datasetSchemaPrefix | uppercase }}</strong>.
                                                                <a href="#/default-mappings">Create one in the Default Mappings section</a>.
                                                            </div>
                                                            <div class="form-horizontal" ng-if="mapping.defaultMappings.length > 0">
                                                                <div class="form-group">
                                                                    <label class="col-sm-3 control-label">Mapping:</label>
                                                                    <div class="col-sm-9">
                                                                        <select class="form-control" ng-model="mapping.selectedDefault"
                                                                                ng-options="m.value as (m.label + ' (' + m.versionCount + ' versions)') for m in mapping.defaultMappings"
                                                                                ng-change="loadDefaultMappingVersions()">
                                                                            <option value="">Select a mapping...</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="form-group" ng-if="mapping.selectedDefault">
                                                                    <label class="col-sm-3 control-label">Version:</label>
                                                                    <div class="col-sm-9">
                                                                        <div class="checkbox">
                                                                            <label>
                                                                                <input type="checkbox" ng-model="mapping.useSpecificVersion">
                                                                                Use specific version (otherwise uses latest)
                                                                            </label>
                                                                        </div>
                                                                        <select class="form-control" ng-model="mapping.defaultVersion"
                                                                                ng-if="mapping.useSpecificVersion" style="margin-top: 5px;">
                                                                            <option ng-repeat="v in mapping.defaultVersions" value="{{ v.hash }}">
                                                                                {{ v.label }}
                                                                            </option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="form-group">
                                                                    <div class="col-sm-offset-3 col-sm-9">
                                                                        <button class="btn btn-primary" ng-click="saveDefaultMappingSelection()"
                                                                                ng-disabled="!mapping.selectedDefault">
                                                                            <i class="fa fa-save"></i> Save Selection
                                                                        </button>
                                                                        <button class="btn btn-info" ng-click="previewDefaultMapping()"
                                                                                ng-disabled="!mapping.selectedDefault">
                                                                            <i class="fa fa-eye"></i> Preview
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Dataset Mapping Version History -->
                                                    <div ng-if="mapping.datasetVersions && mapping.datasetVersions.length > 0">
                                                        <hr>
                                                        <h5>
                                                            <i class="fa fa-history"></i> Dataset Mapping History
                                                            <button class="btn btn-xs btn-default" ng-click="refreshMappingVersions()" title="Refresh mapping history">
                                                                <i class="fa fa-refresh"></i>
                                                            </button>
                                                        </h5>

                                                        <!-- Compare Button -->
                                                        <div class="btn-toolbar" style="margin-bottom: 10px;"
                                                             ng-if="mapping.datasetVersions.length > 1">
                                                            <button class="btn btn-sm btn-info"
                                                                    ng-click="compareDatasetVersions()"
                                                                    ng-disabled="getDatasetSelectedCount() !== 2">
                                                                <i class="fa fa-exchange"></i> Compare Selected
                                                                <span ng-if="getDatasetSelectedCount() > 0">({{ getDatasetSelectedCount() }}/2)</span>
                                                            </button>
                                                            <button class="btn btn-sm btn-default"
                                                                    ng-click="clearDatasetVersionSelections()"
                                                                    ng-if="getDatasetSelectedCount() > 0">
                                                                <i class="fa fa-times"></i> Clear
                                                            </button>
                                                            <span class="text-muted" style="margin-left: 10px; line-height: 30px;">
                                                                Select 2 versions to compare
                                                            </span>
                                                        </div>

                                                        <table class="table table-condensed table-striped">
                                                            <thead>
                                                                <tr>
                                                                    <th style="width: 30px;" ng-if="mapping.datasetVersions.length > 1"></th>
                                                                    <th>Version</th>
                                                                    <th>Date</th>
                                                                    <th>Source</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr ng-repeat="version in mapping.datasetVersions | limitTo:5">
                                                                    <td ng-if="mapping.datasetVersions.length > 1">
                                                                        <input type="checkbox" ng-model="version.selected"
                                                                               ng-disabled="getDatasetSelectedCount() >= 2 && !version.selected">
                                                                    </td>
                                                                    <td>
                                                                        <code>{{ version.hash }}</code>
                                                                        <span class="label label-success" ng-if="version.isCurrent">Current</span>
                                                                    </td>
                                                                    <td>{{ version.timestamp | date:'yyyy-MM-dd HH:mm' }}</td>
                                                                    <td>
                                                                        <span ng-if="version.source === 'sip_upload'">
                                                                            <i class="fa fa-upload"></i> SIP Upload
                                                                        </span>
                                                                        <span ng-if="version.source === 'default_copy'">
                                                                            <i class="fa fa-share"></i> {{ version.sourceDefault }}
                                                                        </span>
                                                                        <span ng-if="version.source === 'rollback'">
                                                                            <i class="fa fa-undo"></i> Rollback
                                                                        </span>
                                                                        <span ng-if="version.source === 'editor'">
                                                                            <i class="fa fa-pencil"></i> Web Editor
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        <button class="btn btn-xs btn-info" ng-click="previewDatasetMapping(version.hash)">
                                                                            <i class="fa fa-eye"></i>
                                                                        </button>
                                                                        <button class="btn btn-xs btn-warning" ng-click="rollbackToVersion(version.hash)"
                                                                                ng-if="!version.isCurrent">
                                                                            <i class="fa fa-undo"></i> Rollback
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                        <p class="text-muted" ng-if="mapping.datasetVersions.length > 5">
                                                            <small>Showing latest 5 versions. Total: {{ mapping.datasetVersions.length }}</small>
                                                        </p>
                                                    </div>

                                                    <div ng-if="!mapping.datasetVersions || mapping.datasetVersions.length === 0" class="alert alert-info">
                                                        <i class="fa fa-info-circle"></i> No mapping versions found for this dataset.
                                                        Upload a SIP file to create the first mapping version.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tabbable dataset-tabs col-md-6">
                                <ul class="nav nav-pills" role="tablist">
                                    <li ng-class="{'active':rightTabOpen === 'drop'}" data-ng-show="dropSupported">
                                        <a href role="tab" data-ng-click="rightTabOpen = 'drop'">File Drop</a>
                                    </li>
                                    <li ng-class="{'active':rightTabOpen === 'harvest'}">
                                        <a href role="tab" data-ng-click="rightTabOpen ='harvest'">Harvest</a>
                                    </li>
                                    <li ng-class="{'active':rightTabOpen === 'harvest-cron'}"
                                        data-ng-show="dataset.harvestType">
                                        <a href role="tab" data-ng-click="rightTabOpen = 'harvest-cron'">Periodic</a>
                                    </li>
                                    <li ng-class="{'active':rightTabOpen === 'id-filter'}">
                                        <a href role="tab" data-ng-click="rightTabOpen = 'id-filter'">ID Filter</a>
                                    </li>
                                    <li data-ng-class="{'active':rightTabOpen==='delete'}">
                                        <a href role="tab" data-ng-click="rightTabOpen ='delete'" class="bg-danger">
                                            <i class="fa fa-trash fa-lg"></i>&nbsp;</a>
                                    </li>
                                </ul>

                                <div class="tab-content clearfix">
                                    <div ng-switch="rightTabOpen">
                                        <div ng-switch-when="drop">
                                            <div data-ng-include="'drop-file-dataset.html'">
                                                drop file
                                            </div>
                                        </div>
                                        <div ng-switch-when="harvest">
                                            <div data-ng-include="'harvest-form.html'">
                                                harvest form
                                            </div>
                                        </div>
                                        <div ng-switch-when="harvest-cron">
                                            <div data-ng-include="'harvest-cron-form.html'">
                                                harvest cron form
                                            </div>
                                        </div>
                                        <div ng-switch-when="id-filter">
                                            <div data-ng-include="'id-filter-form.html'">
                                                id filter form
                                            </div>
                                        </div>
                                        <div ng-switch-when="delete">
                                            <div data-ng-include="'dataset-delete.html'">
                                                deletion form
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity History Modal -->
                    <div class="modal fade" ng-class="{'in': activityModal.visible}" ng-show="activityModal.visible" style="display: block;" ng-if="activityModal.visible">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" ng-click="activityModal.scope.close()" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <h3 class="modal-title">
                                        <i class="fa fa-history"></i> Activity History - {{ activityModal.scope.spec }}
                                    </h3>
                                </div>
                                <div class="modal-body">
                                    <div ng-if="activityModal.scope.loading" class="text-center">
                                        <i class="fa fa-spinner fa-spin fa-2x"></i>
                                        <p>Loading activity log...</p>
                                    </div>

                                    <div ng-if="activityModal.scope.error" class="alert alert-danger">
                                        <i class="fa fa-exclamation-triangle"></i> {{ activityModal.scope.error }}
                                    </div>

                                    <div ng-if="!activityModal.scope.loading && !activityModal.scope.error && activityModal.scope.activities.length === 0" class="alert alert-info">
                                        <i class="fa fa-info-circle"></i> No activity recorded yet.
                                    </div>

                                    <div ng-if="!activityModal.scope.loading && !activityModal.scope.error && activityModal.scope.activities.length > 0">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th width="20"></th>
                                                    <th>Timestamp</th>
                                                    <th>Operation</th>
                                                    <th>Trigger</th>
                                                    <th>Status</th>
                                                    <th>Duration</th>
                                                    <th title="Total records processed">Records</th>
                                                    <th title="Valid records after processing">Valid</th>
                                                    <th title="Invalid records (discarded/errors)">Invalid</th>
                                                    <th title="Deleted records in OAI-PMH">Deleted</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat-start="activity in activityModal.scope.activities"
                                                    ng-if="activity.isWorkflow"
                                                    class="clickable"
                                                    ng-click="activityModal.scope.toggleWorkflow(activity)"
                                                    style="background-color: #f5f5f5; font-weight: bold;">
                                                    <td>
                                                        <i class="fa" ng-class="activity.expanded ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                                                    </td>
                                                    <td>{{ activityModal.scope.formatTimestamp(activity.timestamp) }}</td>
                                                    <td>
                                                        <i class="fa fa-sitemap"></i> {{ activityModal.scope.getOperationLabel(activity) }}
                                                    </td>
                                                    <td>{{ activityModal.scope.getTriggerLabel(activity) }}</td>
                                                    <td>
                                                        <span class="label" ng-class="activityModal.scope.getStatusClass(activity.status)">
                                                            {{ activity.status || 'in progress' }}
                                                        </span>
                                                        <span ng-if="activity.errorMessage" class="text-danger">
                                                            <br/>{{ activity.errorMessage }}
                                                        </span>
                                                        <span ng-if="activity.affectedRecordCount" class="text-muted">
                                                            <br/><small>Affected records: {{ activity.affectedRecordCount }}</small>
                                                        </span>
                                                    </td>
                                                    <td>{{ activityModal.scope.formatDuration(activity.duration_seconds) }}</td>
                                                    <td>{{ activity.total_records || activity.recordCount || '-' }}</td>
                                                    <td>{{ activity.valid_records || '-' }}</td>
                                                    <td>{{ activity.invalid_records || '-' }}</td>
                                                    <td>
                                                        <span ng-if="activity.deleted_records > 0" class="text-warning" title="Deleted in OAI-PMH">
                                                            {{ activity.deleted_records }}
                                                        </span>
                                                        <span ng-if="!activity.deleted_records || activity.deleted_records == 0">-</span>
                                                    </td>
                                                </tr>

                                                <tr ng-if="activity.isWorkflow && activity.expanded" ng-repeat="step in activity.steps"
                                                    style="background-color: #fafafa;">
                                                    <td></td>
                                                    <td style="padding-left: 30px;">{{ activityModal.scope.formatTimestamp(step.timestamp) }}</td>
                                                    <td style="padding-left: 30px;">
                                                        <i class="fa fa-angle-right"></i> {{ step.operation }}
                                                    </td>
                                                    <td>-</td>
                                                    <td>
                                                        <span class="label" ng-class="activityModal.scope.getStatusClass(step.status)">
                                                            {{ step.status }}
                                                        </span>
                                                    </td>
                                                    <td>{{ activityModal.scope.formatDuration(step.duration_seconds) }}</td>
                                                    <td>{{ step.recordCount || '-' }}</td>
                                                    <td>{{ step.valid_records || '-' }}</td>
                                                    <td>{{ step.invalid_records || '-' }}</td>
                                                    <td>
                                                        <span ng-if="step.deleted_records > 0" class="text-warning">
                                                            {{ step.deleted_records }}
                                                        </span>
                                                        <span ng-if="!step.deleted_records || step.deleted_records == 0">-</span>
                                                    </td>
                                                </tr>

                                                <tr ng-repeat-end ng-if="!activity.isWorkflow">
                                                    <td></td>
                                                    <td>{{ activityModal.scope.formatTimestamp(activity.timestamp) }}</td>
                                                    <td>{{ activity.operation }}</td>
                                                    <td>{{ activityModal.scope.getTriggerLabel(activity) }}</td>
                                                    <td>
                                                        <span class="label" ng-class="activityModal.scope.getStatusClass(activity.status)">
                                                            {{ activity.status }}
                                                        </span>
                                                        <span ng-if="activity.errorMessage" class="text-danger">
                                                            <br/>{{ activity.errorMessage }}
                                                        </span>
                                                        <span ng-if="activity.affectedRecordCount" class="text-muted">
                                                            <br/><small>Affected records: {{ activity.affectedRecordCount }}</small>
                                                        </span>
                                                    </td>
                                                    <td>{{ activityModal.scope.formatDuration(activity.duration_seconds) }}</td>
                                                    <td>{{ activity.total_records || activity.recordCount || '-' }}</td>
                                                    <td>{{ activity.valid_records || '-' }}</td>
                                                    <td>{{ activity.invalid_records || '-' }}</td>
                                                    <td>
                                                        <span ng-if="activity.deleted_records > 0" class="text-warning" title="Deleted in OAI-PMH">
                                                            {{ activity.deleted_records }}
                                                        </span>
                                                        <span ng-if="!activity.deleted_records || activity.deleted_records == 0">-</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-default" ng-click="activityModal.scope.close()">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-backdrop fade" ng-class="{'in': activityModal.visible}" ng-show="activityModal.visible" ng-click="activityModal.scope.close()"></div>

                </div>
            </div>
        </div>
    </div>
    <div data-ng-show="newFileOpen">
        <div data-ng-include="'new-dataset.html'">new dataset</div>
    </div>
</div>

<script type="text/ng-template" id="dataset-metadata-form.html" class="">
    <form name="metadataform" class="form-horizontal" novalidate ng-submit="submitMetadataForm(metadataform)">
        <fieldset>
            <div class="form-group" ng-class="{'has-error' : metadataform.meta_name.$invalid, 'has-success' : metadataform.meta_name.$valid && !metadataform.meta_name.$pristine }">
                <label for="meta_name" class="col-sm-3 control-label">Dataset Name</label>
                <div class="col-sm-9">
                    <input id="meta_name" name="meta_name" required class="form-control" data-ng-model="dataset.edit.datasetName"/>
                </div>
            </div>
            <div class="form-group" ng-class="{'has-error' : metadataform.meta_description.$invalid, 'has-success' : metadataform.meta_description.$valid && !metadataform.meta_description.$pristine }">
                <label class="col-sm-3 control-label" for="meta_description">Description</label>
                <div class="col-sm-9">
                    <input id="meta_description" name="meta_description" class="form-control" data-ng-model="dataset.edit.datasetDescription"/>
                </div>
            </div>
            <div class="form-group" ng-class="{'has-error' : metadataform.meta_aggr.$invalid, 'has-success' : metadataform.meta_aggr.$valid && !metadataform.meta_aggr.$pristine }">
                <label class="col-sm-3 control-label" for="meta_aggr">Aggregator</label>
                <div class="col-sm-9">
                    <input id="meta_aggr" name="meta_aggr" required class="form-control" data-ng-model="dataset.edit.datasetAggregator"/>
                </div>
            </div>
            <div class="form-group" ng-class="{'has-error' : metadataform.meta_owner.$invalid, 'has-success' : metadataform.meta_owner.$valid && !metadataform.meta_owner.$pristine }">
                <label class="col-sm-3 control-label" for="meta_owner">Owner</label>
                <div class="col-sm-9">
                    <input id="meta_owner" name="meta_owner" required class="form-control" data-ng-model="dataset.edit.datasetOwner"/>
                </div>
            </div>
            <div class="form-group" ng-class="{'has-error' : metadataform.meta_dataProviderURL.$invalid, 'has-success' : metadataform.meta_dataProviderURL.$valid }">
                <label class="col-sm-3 control-label" for="meta_dataProviderURL">Data Provider URL</label>
                <div class="col-sm-9">
                    <input id="meta_dataProviderURL" name="meta_dataProviderURL" class="form-control" data-ng-model="dataset.edit.datasetDataProviderURL"/>
                </div>
            </div>
            <div class="form-group" ng-class="{'has-error' : metadataform.meta_language.$invalid, 'has-success' : metadataform.meta_language.$valid && !metadataform.meta_language.$pristine }">
                <label class="col-sm-3 control-label" for="meta_language">Language</label>
                <div class="col-sm-9">
                    <input id="meta_language" name="meta_language" required class="form-control" data-ng-model="dataset.edit.datasetLanguage"/>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label" for="meta_edm_type">Type</label>
                <div class="col-sm-9">
                <input id="meta_edm_type" name="meta_edm_type" class="form-control" data-ng-model="dataset.edit.edmType"/>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label" for="meta_dataset_tags">Tags</label>
            <div class="col-sm-9">
                <input id="meta_dataset_tags" name="meta_dataset_tags" class="form-control" data-ng-model="dataset.edit.datasetTags"/>
                </div>
            </div>
            <div class="form-group" ng-class="{'has-error' : metadataform.meta_rights.$invalid, 'has-success' : metadataform.meta_rights.$valid && !metadataform.meta_rights.$pristine }">
                <label class="col-sm-3 control-label" for="meta_rights">Rights</label>
                <div class="col-sm-9">
                    <!--<input id="meta_rights" class="form-control" data-ng-model="dataset.edit.datasetRights"/>-->
                    <select name="singleSelect" id="meta_rights" data-ng-model="dataset.edit.datasetRights" class="form-control">
                        <option value="">---Please select---</option> <!-- not selected / blank option -->

                        <option value="http://rightsstatements.org/vocab/InC/1.0/">IN COPYRIGHT</option>
                        <option value="http://rightsstatements.org/vocab/InC-OW-EU/1.0/">IN COPYRIGHT - EU ORPHAN WORK</option>
                        <option value="http://rightsstatements.org/vocab/InC-EDU/1.0/">IN COPYRIGHT - EDUCATIONAL USE PERMITTED</option>
                        <option value="http://rightsstatements.org/vocab/InC-NC/1.0/">IN COPYRIGHT - NON-COMMERCIAL USE PERMITTED</option>
                        <option value="http://rightsstatements.org/vocab/InC-RUU/1.0/">IN COPYRIGHT - RIGHTS-HOLDER(S) UNLOCATABLE OR UNIDENTIFIABLE</option>
                        <option value="http://creativecommons.org/publicdomain/mark/1.0/">Public Domain Mark (PDM)</option>
                        <option value="http://creativecommons.org/publicdomain/zero/1.0/">The Creative Commons CC0 1.0 Universal Public Domain Dedication (CC0)</option>
                        <option value="http://creativecommons.org/licenses/by/4.0/">Creative Commons - Attribution (BY)</option>
                        <option value="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons - Attribution, ShareAlike (BY-SA)</option>
                        <option value="http://creativecommons.org/licenses/by-nd/4.0/">Creative Commons - Attribution, No Derivatives (BY-ND)</option>
                        <option value="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons - Attribution, Non-Commercial (BY-NC)</option>
                        <option value="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons - Attribution, Non-Commercial, ShareAlike (BY-NC-SA)</option>
                        <option value="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons - Attribution, Non-Commercial, No Derivatives (BY-NC-ND)</option>
                    </select>
                </div>
            </div>
            <div ng-if="supportedDatasetTypes.length !== 0" class="form-group" ng-class="{'has-error' : metadataform.meta_type.$invalid, 'has-success' : metadataform.meta_type.$valid && !metadataform.meta_type.$pristine }">
                <label class="col-sm-3 control-label" for="meta_dataset_type">Data Type</label>
                <div class="col-sm-9">
                    <select name="singleSelect" id="meta_dataset_type" data-ng-model="dataset.edit.datasetType" class="form-control">
                        <option ng-repeat="supportedDatasetType in supportedDatasetTypes"
                                ng-selected="{{supportedDatasetType === dataset.edit.datasetType}}"
                                value="{{supportedDatasetType}}">
                            {{supportedDatasetType}}
                        </option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-success btn-sm" data-ng-disabled="unchangedMetadata">
                <i class="fa fa-check-circle"></i>
                <span>Save</span>
            </button>
        </fieldset>
    </form>
</script>

<script type="text/ng-template" id="drop-file-dataset.html">
    <div>
        <div class="file-drop col-md-12  alert alert-info" ng-class="{'disabled': datasetBusy == true}" ng-file-drop="receiveDropped($files)" ng-file-drag-over-class="file-drop-over">
            <div ng-if="!datasetBusy" class="text-center">
                <i class="fa fa-arrow-circle-o-down fa-5x"></i>
                <p>Drag and drop your XML, CSV source or prepared SIP-zip file into this area</p>
            </div>
            <div ng-if="datasetBusy" class="text-center">
                <div class="img-holder" data-ng-show="datasetBusy">
                    <i class="busy1 fa fa-gear fa-spin fa-5x"></i>
                    <i class="busy2 fa fa-gear fa-spin-left fa-4x"></i>
                    <i class="busy3 fa fa-gear fa-spin-left fa-5x"></i>
                </div>
                <p class="alert alert-info">BUSY</p>
            </div>
            <div data-ng-if="dataset.uploadPercent">
                <progressbar class="progress-striped active" animate="true" value="dataset.uploadPercent" max="100" type="success">
                    <b>{{ dataset.uploadPercent }}%</b>
                </progressbar>
            </div>
        </div>
    </div>
</script>

<script type="text/ng-template" id="harvest-form.html">
    <form name="form" class="form-horizontal">
        <fieldset>
            <div class="form-group">
                <label class="col-sm-3" for="harvest_type">Harvest Server Type</label>

                <div id="harvest_type" class="col-sm-9">
                    <input type="radio" ng-model="dataset.edit.harvestType" value="pmh">
                    <span>OAI-PMH</span>
                    <span>&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    <input type="radio" ng-model="dataset.edit.harvestType" value="adlib">
                    <span>AdLib API</span>
                    <span>&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    <input type="radio" ng-model="dataset.edit.harvestType" value="download">
                    <span>Download</span>
                    <span>&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    <input type="radio" ng-model="dataset.edit.harvestType" value="json">
                    <span>JSON API</span>
                </div>

            </div>
            <div class="form-group" data-ng-show="dataset.edit.harvestType != 'download'">
                <label class="col-sm-3" for="harv_url">Server URL</label>
                <div class="col-sm-9">
                    <input id="harv_url" class="form-control" data-ng-model="dataset.edit.harvestURL" placeholder="http://...?" required/>
                </div>
            </div>
            <div class="form-group" data-ng-show="dataset.edit.harvestType != 'download' && dataset.edit.harvestType != 'json'">
                <label class="col-sm-3" for="harv_set">Server Dataset</label>
                <div class="col-sm-9">
                    <input id="harv_set" class="form-control" data-ng-model="dataset.edit.harvestDataset" placeholder="dataset"/>
                </div>
            </div>
            <div class="form-group" data-ng-show="dataset.edit.harvestType != 'download' && dataset.edit.harvestType != 'json'">
                <label class="col-sm-3" for="harv_record">Record identifier</label>
                <div class="col-sm-9">
                    <input id="harv_record" class="form-control" data-ng-model="dataset.edit.harvestRecord" placeholder="record identifier"/>
                </div>
            </div>
            <div class="form-group" data-ng-show="dataset.edit.harvestType == 'pmh'">
                <label class="col-sm-3" for="harv_prefix">Metadata Prefix</label>
                <div class="col-sm-9">
                    <input id="harv_prefix" class="form-control" data-ng-model="dataset.edit.harvestPrefix" placeholder="prefix" required/>
                </div>
            </div>
            <div class="form-group" data-ng-show="dataset.edit.harvestType == 'adlib' && dataset.edit.harvestType != 'download'">
                <label class="col-sm-3" for="harv_search">Search</label>
                <div class="col-sm-9">
                    <input id="harv_search" class="form-control" data-ng-model="dataset.edit.harvestSearch" placeholder="search" required/>
                </div>
            </div>
            <!-- Basic Auth credentials (AdLib-specific) -->
            <div class="form-group" data-ng-show="dataset.edit.harvestType == 'adlib'">
                <label class="col-sm-3" for="harv_username">Username</label>
                <div class="col-sm-9">
                    <input id="harv_username" class="form-control" data-ng-model="dataset.edit.harvestUsername" placeholder="(optional)"/>
                </div>
            </div>
            <div class="form-group" data-ng-show="dataset.edit.harvestType == 'adlib'">
                <label class="col-sm-3" for="harv_password">Password</label>
                <div class="col-sm-9">
                    <input id="harv_password" type="password" class="form-control" data-ng-model="dataset.edit.harvestPassword" placeholder="{{ dataset.harvestPasswordSet ? '' : '(optional)' }}"/>
                    <p class="help-block text-muted" data-ng-show="dataset.harvestPasswordSet">Leave blank to keep existing password</p>
                </div>
            </div>
            <!-- Error Handling Configuration (AdLib-specific) -->
            <div class="form-group" data-ng-show="dataset.edit.harvestType == 'adlib'">
                <label class="col-sm-3">Error Handling</label>
                <div class="col-sm-9">
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" data-ng-model="dataset.edit.harvestContinueOnError" ng-true-value="'true'" ng-false-value="'false'"/>
                            Continue harvesting when encountering errors
                        </label>
                        <p class="help-block">
                            If enabled, harvest will continue when pages fail and retry individual records.
                            Failed records will be stored separately for manual review.
                        </p>
                    </div>
                </div>
            </div>
            <div class="form-group" data-ng-show="dataset.edit.harvestType == 'adlib' && dataset.edit.harvestContinueOnError">
                <label class="col-sm-3" for="error_threshold">Error Threshold (%)</label>
                <div class="col-sm-9">
                    <input type="number" id="error_threshold" class="form-control" min="0" max="100" data-ng-model="dataset.edit.harvestErrorThreshold" placeholder="10"/>
                    <p class="help-block">
                        Stop harvesting if error rate exceeds this percentage (0 = unlimited errors)
                    </p>
                </div>
            </div>
            <div class="form-group" data-ng-show="dataset.edit.harvestType == 'download'">
                <label class="col-sm-3" for="download_url">Download URL</label>
                <div class="col-sm-9">
                    <input id="download_url" class="form-control" data-ng-model="dataset.edit.harvestDownloadURL" placeholder="http://...?" required/>
                </div>
            </div>

            <!-- JSON API Configuration -->
            <div data-ng-show="dataset.edit.harvestType == 'json'">
                <div class="form-group">
                    <label class="col-sm-3" for="json_items_path">Items Path</label>
                    <div class="col-sm-9">
                        <input id="json_items_path" class="form-control" data-ng-model="dataset.edit.harvestJsonItemsPath" placeholder="e.g., Items or data.results" required/>
                        <p class="help-block">JSON path to the array of records (dot notation)</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_id_path">ID Path</label>
                    <div class="col-sm-9">
                        <input id="json_id_path" class="form-control" data-ng-model="dataset.edit.harvestJsonIdPath" placeholder="e.g., ID or record.id" required/>
                        <p class="help-block">JSON path to the unique record identifier</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_total_path">Total Count Path</label>
                    <div class="col-sm-9">
                        <input id="json_total_path" class="form-control" data-ng-model="dataset.edit.harvestJsonTotalPath" placeholder="e.g., TotalItems (optional)"/>
                        <p class="help-block">JSON path to total record count (for progress display)</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_page_param">Page Parameter</label>
                    <div class="col-sm-9">
                        <input id="json_page_param" class="form-control" data-ng-model="dataset.edit.harvestJsonPageParam" placeholder="page"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_pagesize_param">Page Size Parameter</label>
                    <div class="col-sm-9">
                        <input id="json_pagesize_param" class="form-control" data-ng-model="dataset.edit.harvestJsonPageSizeParam" placeholder="pagesize"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_pagesize">Page Size</label>
                    <div class="col-sm-9">
                        <input type="number" id="json_pagesize" class="form-control" data-ng-model="dataset.edit.harvestJsonPageSize" placeholder="50"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_detail_path">Detail Path</label>
                    <div class="col-sm-9">
                        <input id="json_detail_path" class="form-control" data-ng-model="dataset.edit.harvestJsonDetailPath" placeholder="e.g., /items/{id} (optional)"/>
                        <p class="help-block">URL path for individual record details (use {id} placeholder)</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3">Skip Detail Fetch</label>
                    <div class="col-sm-9">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" data-ng-model="dataset.edit.harvestJsonSkipDetail" ng-true-value="'true'" ng-false-value="'false'"/>
                                Use list data directly without fetching individual records
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_xml_root">XML Root Element</label>
                    <div class="col-sm-9">
                        <input id="json_xml_root" class="form-control" data-ng-model="dataset.edit.harvestJsonXmlRoot" placeholder="records"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_xml_record">XML Record Element</label>
                    <div class="col-sm-9">
                        <input id="json_xml_record" class="form-control" data-ng-model="dataset.edit.harvestJsonXmlRecord" placeholder="record"/>
                    </div>
                </div>
                <!-- JSON Authentication Options -->
                <div class="form-group">
                    <label class="col-sm-3" for="json_username">Basic Auth Username</label>
                    <div class="col-sm-9">
                        <input id="json_username" class="form-control" data-ng-model="dataset.edit.harvestUsername" placeholder="(optional)"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_password">Basic Auth Password</label>
                    <div class="col-sm-9">
                        <input id="json_password" type="password" class="form-control" data-ng-model="dataset.edit.harvestPassword" placeholder="{{ dataset.harvestPasswordSet ? '' : '(optional)' }}"/>
                        <p class="help-block text-muted" data-ng-show="dataset.harvestPasswordSet">Leave blank to keep existing password</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_apikey_param">API Key Parameter</label>
                    <div class="col-sm-9">
                        <input id="json_apikey_param" class="form-control" data-ng-model="dataset.edit.harvestApiKeyParam" placeholder="e.g., api_key (optional)"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="json_apikey">API Key</label>
                    <div class="col-sm-9">
                        <input id="json_apikey" type="password" class="form-control" data-ng-model="dataset.edit.harvestApiKey" placeholder="{{ dataset.harvestApiKeySet ? '' : '(optional)' }}"/>
                        <p class="help-block text-muted" data-ng-show="dataset.harvestApiKeySet">Leave blank to keep existing API key</p>
                    </div>
                </div>
            </div>

            <div class="btn-group  pull-right" role="group">
                <button type="button" class="btn btn-default" data-ng-click="start('start first harvest', 'Erase existing data, including records from the triple-store?')" data-ng-disabled="!unchangedHarvest">
                    <i class="fa fa-download"></i>
                    <span>Harvest</span>
                </button>
                <button type="button" class="btn btn-default" data-ng-click="start('start sample harvest', 'Erase existing data,including records from the triple-store?')" data-ng-disabled="!unchangedHarvest">
                    <i class="fa fa-binoculars"></i>
                    <span>Sample</span>
                </button>
                <a href="/narthex/preview/{{ pmhPreviewEncoded }}" data-ng-show="dataset.edit.harvestType == 'pmh'" target="_blank" type="button" class="btn btn-default" data-ng-disabled="!unchangedHarvest">
                    <i class="fa fa-binoculars"></i>
                    <span>Preview</span>
                </a>
                <a href="/narthex/preview/{{ adlibPreviewEncoded }}?__spec={{ dataset.datasetSpec }}" data-ng-show="dataset.edit.harvestType == 'adlib'" target="_blank" type="button" class="btn btn-default" data-ng-disabled="!unchangedHarvest">
                    <i class="fa fa-binoculars"></i>
                    <span>Preview</span>
                </a>
                <a href="/narthex/preview/{{ dataset.edit.harvestDownloadURL }}" data-ng-show="dataset.edit.harvestType == 'download'" target="_blank" type="button" class="btn btn-default">
                    <i class="fa fa-binoculars"></i>
                    <span>Preview</span>
                </a>
                <a href="/narthex/preview/json/{{ dataset.datasetSpec }}" data-ng-show="dataset.edit.harvestType == 'json'" target="_blank" type="button" class="btn btn-default" data-ng-disabled="!unchangedHarvest">
                    <i class="fa fa-binoculars"></i>
                    <span>Preview</span>
                </a>
            </div>
            <button type="button" class="btn btn-success" data-ng-click="setHarvest()" data-ng-disabled="unchangedHarvest">
                <i class="fa fa-check-circle"></i>
                <span>Save</span>
            </button>

        </fieldset>
    </form>
</script>

<script type="text/ng-template" id="harvest-cron-form.html">
    <form name="form" class="form-horizontal">
        <fieldset>
            <div class="form-group">
                <label class="col-sm-3" for="hc_prev">Previous</label>
                <div class="col-sm-9">
                    <input id="hc_prev" class="form-control" data-ng-model="dataset.edit.harvestPreviousTime"/>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3" for="hc_delay">Interval</label>
                <div class="col-sm-9">
                    <input id="hc_delay" class="form-control" data-ng-model="dataset.edit.harvestDelay"/>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3" for="hc_unit">Unit</label>
                <div class="col-sm-9">
                    <div id="hc_unit">
                        <input type="radio" ng-model="dataset.edit.harvestDelayUnit" value="weeks">
                        <span>Week(s)</span>
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        <input type="radio" ng-model="dataset.edit.harvestDelayUnit" value="days">
                        <span>Day(s)</span>
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        <input type="radio" ng-model="dataset.edit.harvestDelayUnit" value="hours">
                        <span>Hour(s)</span>
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        <input type="radio" ng-model="dataset.edit.harvestDelayUnit" value="minutes">
                        <span>Minute(s)</span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3" for="hc_inc">Harvest type</label>
                <div class="col-sm-9">
                    <div id="hc_inc">
                        <input type="radio" ng-model="dataset.edit.harvestIncremental" value="false">
                        <span>Full harvest</span>
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        <span data-ng-show={{enableIncrementalHarvest}}>
                            <input type="radio" ng-model="dataset.edit.harvestIncremental" value="true">
                            <span>Incremental harvest</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="alert alert-info">
                    Harvesting is executed only if the Dataset is in either Saved or Incremental Saved state.
                </div>
            </div>
            <button type="button" class="btn btn-success" data-ng-click="setHarvestCron()" data-ng-disabled="unchangedHarvestCron">
                <i class="fa fa-check-circle"></i>
                <span>Save</span>
            </button>
            <a ng-href="{{ getIncrementalPreviewUrl() }}" target="_blank" class="btn btn-default pull-right" data-ng-disabled="!incrementalPreview">
                <i class="fa fa-binoculars"></i>
                <span>Preview</span>
            </a>
        </fieldset>
    </form>
</script>

<script type="text/ng-template" id="id-filter-form.html">
    <form name="form" class="form-horizontal">
        <fieldset>
            <div class="form-group">
                <label class="col-sm-3" for="id_filter_type">Filter Type</label>
                <div class="col-sm-9">
                    <div id="id_filter_type">
                        <p><input type="radio" ng-model="dataset.edit.idFilterType" value="verbatim">
                            <span>Verbatim</span></p>
                        <p><input type="radio" ng-model="dataset.edit.idFilterType" value="sha256-hash">
                            <span>Hash (SHA256/Base32)</span></p>
                        <p>
                            <input type="radio" ng-model="dataset.edit.idFilterType" value="replacement">
                            <span>Replacement</span>
                        </p>
                    </div>
                </div>
            </div>
            <div data-ng-show="dataset.edit.idFilterType == 'replacement'">
                <div class="form-group">
                    <label class="col-sm-3" for="id_filter_input">Test input</label>
                    <div class="col-sm-9">
                        <input id="id_filter_input" class="form-control" data-ng-model="idFilter.input" placeholder="identifier"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3" for="id_filter_expression">Filter Expression</label>
                    <div class="col-sm-9">
                        <input id="id_filter_expression" class="form-control" data-ng-model="dataset.edit.idFilterExpression" placeholder="REGEX:::REPLACEMENT"/>
                    </div>
                </div>
                <div class="form-group" data-ng-class="{ 'error': idFilter.error }">
                    <label class="col-sm-3" for="id_filter_output">Test output</label>
                    <div class="col-sm-9">
                        <input id="id_filter_output" class="form-control" data-ng-model="idFilter.output" placeholder="transformed identifier"/>
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-success" data-ng-click="setIdFilter()" data-ng-disabled="unchangedIdFilter">
                <i class="fa fa-check-circle"></i>
                <span>Save</span>
            </button>

        </fieldset>
    </form>
</script>

<script type="text/ng-template" id="publication-form.html">
    <form name="form" class="form">
        <fieldset>
            <div class="checkbox">
                <label for="pub_pmh">Publish via OAI-PMH
                    <input id="pub_pmh" type="checkbox" data-ng-model="dataset.edit.publishOAIPMH" ng-true-value="'true'" ng-false-value="'false'"/>
                </label>
            </div>
            <div class="checkbox">
                <label for="pub_index">Publish in the Index
                    <input id="pub_index" type="checkbox" data-ng-model="dataset.edit.publishIndex" ng-true-value="'true'" ng-false-value="'false'"/>
                </label>
            </div>
            <div class="checkbox">
                <label for="pub_lod">Publish as Linked Open Data
                    <input id="pub_lod" type="checkbox" data-ng-model="dataset.edit.publishLOD" ng-true-value="'true'" ng-false-value="'false'"/>
                </label>
            </div>
            <button type="button" class="btn btn-success btn-sm" data-ng-click="setPublish()" data-ng-disabled="unchangedPublish">
                <i class="fa fa-check-circle"></i>
                <span>Save</span>
            </button>
        </fieldset>
    </form>
</script>

<script type="text/ng-template" id="categories-form.html">
    <form name="form" class="form">
        <fieldset>
            <div class="checkbox">
                <label for="cat">Include in Category Monitor Statistics
                    <input id="cat" type="checkbox" data-ng-model="dataset.edit.categoriesInclude" ng-true-value="'true'" ng-false-value="'false'"/>
                </label>
            </div>
            <button typ="button" class="btn btn-success btn-sm" data-ng-click="setCategories()" data-ng-disabled="unchangedCategories">
                <i class="fa fa-check-circle"></i>
                <span>Save</span>
            </button>
        </fieldset>
    </form>
</script>

<script type="text/ng-template" id="downloads.html"></script>

<script type="text/ng-template" id="check-links.html">
    <ul class="list-group">
        <li class="list-group-item">
            <a class="" ng-href="{{ searchLink }}" target="_blank">
                <i class="fa fa-search"></i> <span>Search</span>
            </a>
        </li>
        <li class="list-group-item">
            <a class="" ng-href="{{ apiLink }}" target="_blank">
                <i class="fa fa-binoculars"></i> <span>API</span>
            </a>
        </li>
        <li class="list-group-item">
            <a class="" ng-href="{{ oaiPmhLink }}" target="_blank">
                <i class="fa fa-download"></i> <span>OAI-PMH</span>
            </a>
        </li>
        <li class="list-group-item">
            <a class="" ng-href="{{ sparqlPath }}" target="_blank">
                <i class="fa fa-database"></i> <span>SPARQL</span>
            </a>
        </li>
        <li class="list-group-item">
            <a class="" ng-href="{{ apiDownloadSipZip }}" target="_blank">
                <i class="fa fa-download"></i> <span>Download SipZip</span>
            </a>
        </li>
        <li class="list-group-item">
            <a class="" ng-href="{{ apiPathErrors }}" target="_blank">
                <i class="fa fa-exclamation-circle"></i> <span>Show errors </span>
            </a>
        </li>
        <li class="list-group-item">
            <a class="" ng-href="{{ apiPathBulkActions }}" target="_blank">
                <i class="fa fa-terminal"></i> <span> Show bulkActions</span>
            </a>
        </li>
        <li class="list-group-item">
            <a class="" ng-href="{{ apiPathNquads}}" target="_blank">
                <i class="fa fa-terminal"></i> <span> Show nquads</span>
            </a>
        </li>
    </ul>
</script>

<!--<script type="text/ng-template" id="mapping.html">-->
<!--<div class="panel panel-default">-->
<!--<div class="panel-body">-->
<!--<label>WebResource Path:</label>-->
<!--<code class="success">{{ apiWebResourcePath }}</code>-->
<!--</div>-->
<!--</div>-->
<!--</script>-->

<script type="text/ng-template" id="harvesting-info.html">
<!-- Record Count Summary -->
<ul class="list-group">
    <li class="list-group-item">
        <strong>Record Counts</strong>
    </li>
    <li class="list-group-item">
        <i data-ng-if="dataset.acquisitionMethod == 'harvest'" class="fa fa-download text-info"></i>
        <i data-ng-if="dataset.acquisitionMethod == 'upload'" class="fa fa-upload text-muted"></i>
        <i data-ng-if="!dataset.acquisitionMethod" class="fa fa-question text-muted"></i>
        Acquired: <strong>{{ dataset.acquiredRecordCount || dataset.datasetRecordCount || '-' }}</strong>
        <span data-ng-if="dataset.acquisitionMethod" class="text-muted">({{ dataset.acquisitionMethod }})</span>
    </li>
    <li class="list-group-item" data-ng-if="dataset.deletedRecordCount > 0">
        <i class="fa fa-minus-circle text-warning"></i>
        Deleted (OAI-PMH): <strong class="text-warning">{{ dataset.deletedRecordCount }}</strong>
    </li>
    <li class="list-group-item">
        <i class="fa fa-file-text-o text-info"></i>
        Source records: <strong>{{ dataset.sourceRecordCount || ((dataset.acquiredRecordCount || dataset.datasetRecordCount || 0) - (dataset.deletedRecordCount || 0)) || '-' }}</strong>
    </li>
    <li class="list-group-item">
        <i class="fa fa-check text-success"></i>
        Valid: <strong class="text-success">{{ dataset.processedValid || '-' }}</strong>
    </li>
    <li class="list-group-item" data-ng-if="dataset.processedInvalid > 0">
        <i class="fa fa-times text-danger"></i>
        Invalid: <strong class="text-danger">{{ dataset.processedInvalid }}</strong>
    </li>
</ul>

<!-- Full Harvest Info -->
<ul class="list-group">
    <li class="list-group-item">
        <strong>Full Harvest</strong>
    </li>
    <li class="list-group-item">
        Last harvest: {{ dataset.lastFullHarvestTime || '-' }}
    </li>
    <li class="list-group-item">Record definition: {{ dataset.datasetMapToPrefix || '-' }}</li>
</ul>

<!-- Incremental Harvest Info (if enabled) -->
<ul class="list-group" data-ng-if="dataset.harvestIncrementalMode == 'true'">
    <li class="list-group-item">
        <strong>Incremental Harvest</strong>
        <span class="label label-info pull-right">Scheduled</span>
    </li>
    <li class="list-group-item">Last scheduled: {{ dataset.lastIncrementalHarvestTime || '-' }}</li>
    <li class="list-group-item">
        <i class="fa fa-check text-success"></i>
        Valid: <strong class="text-success">{{ dataset.processedIncrementalValid || '-' }}</strong>
    </li>
    <li class="list-group-item" data-ng-if="dataset.processedIncrementalInvalid > 0">
        <i class="fa fa-times text-danger"></i>
        Invalid: <strong class="text-danger">{{ dataset.processedIncrementalInvalid }}</strong>
    </li>
</ul>

<!-- Quick Links -->
<ul class="list-group">
    <li class="list-group-item"><a ng-href="" data-ng-click="showLastSourcedPage()"><i class="fa fa-list"></i> Last harvested records</a></li>
    <li class="list-group-item"><a ng-href="" data-ng-click="showHarvestingLog()"><i class="fa fa-file-text-o"></i> Harvesting log</a></li>
    <li class="list-group-item"><a ng-href="" data-ng-click="showLastProcessedPage()"><i class="fa fa-check-circle"></i> Last processed records</a></li>
    <li class="list-group-item"><a ng-href="" data-ng-click="showInvalidRecordsPage()"><i class="fa fa-exclamation-circle"></i> Last processing errors</a></li>
</ul>
</script>

<script type="text/ng-template" id="dataset-delete.html">
    <div data-ng-show="dataset.stateRaw || dataset.stateSourced || dataset.stateAnalyzed || dataset.stateProcessed">
        <div class="alert alert-warning">
            Removing the results of a workflow phase returns the dataset to a previous state, at which point
            the subsequent processes can be repeated.
        </div>
        <div>
            <button class="btn btn-warning" data-ng-show="dataset.stateRaw" data-ng-click="remove('remove raw', 'Remove raw file?')">
                <i class="fa fa-trash"></i> Raw
            </button>
            <button class="btn btn-warning" data-ng-show="dataset.stateSourced" data-ng-click="remove('remove source', 'Remove source records?')">
                <i class="fa fa-trash"></i> Source
            </button>
            <button class="btn btn-warning" data-ng-show="dataset.stateProcessed" data-ng-click="remove('remove processed', 'Remove processsed records?')">
                <i class="fa fa-trash"></i> Processed
            </button>
            <button class="btn btn-warning" data-ng-show="dataset.stateAnalyzed" data-ng-click="remove('remove tree', 'Remove Analysis?')">
                <i class="fa fa-trash"></i> Analysis
            </button>
            <button class="btn btn-warning" data-ng-show="dataset.stateSaved" data-ng-click="remove('delete index', 'Delete Records?')">
                <i class="fa fa-trash"></i> Records
            </button>
        </div>
        <hr/>
    </div>
    <div class="alert alert-warning">
        Only reset a dataset after the buttons of the workflow become unresponsive. To make sure that it is not a websockets issue
        make sure you do a hard refresh of the page first, i.e. Ctrl-F5.
    </div>
    <form name="form" class="form">
        <fieldset>
            <button class="btn btn-warning" data-ng-click="resetDatasetState()">reset dataset state</button>
        </fieldset>
        <hr/>
    </form>
    <div class="alert alert-danger">
        By clicking the 'Delete' button below you will remove the entire dataset and all its accompanying information.
        <strong>This process is <em>not</em> reversible so proceed with caution!</strong>
    </div>
    <form name="form" class="form">
        <fieldset>
            <button class="btn btn-warning" data-ng-click="remove('disable dataset', 'Disable dataset?')">
                <i class="fa fa-trash"></i> Disable Dataset
            </button>
            <button class="btn btn-danger" data-ng-click="deleteDataset(dataset)">
                <i class="fa fa-trash"></i> Delete Dataset
            </button>
        </fieldset>
    </form>
</script>

<script type="text/ng-template" id="new-dataset.html">
    <div class="aside-backdrop am-fade" style=""></div>
    <div class="aside right animated fadeInRightBig">
        <div class="aside-dialog">
            <div class="aside-content">
                <div class="aside-header">
                    Create a new dataset:
                </div>
                <div class="aside-body">
                    <form name="form" class="form" action=".">
                        <fieldset>
                            <div class="form-group">
                                <label for="new-name">Dataset Short Name</label>
                                <input id="new-name" class="form-control" data-ng-model="newDataset.specTyped" placeholder="spec" required autofocus/>
                            </div>
                            <div data-ng-if="characters.length > 1">
                  <span data-ng-repeat="ch in characters" class="radio">
                      <label>
                          <input type="radio" name="character" data-ng-model="newDataset.character" data-ng-value="ch"> {{ ch.title }}
                      </label>
                  </span>
                            </div>
                            <div data-ng-if="characters.length == 1">
                                {{ characters[0].title }}
                            </div>
                            <hr/>
                            <div class="form-group">
                  <span type="button" class="btn btn-success" data-ng-class="{ 'disabled': !newDataset.enabled }" data-ng-click="createDataset()">
                      <i class="fa fa-plus"></i> <span>Create</span>
                      <span>"{{ newDataset.spec }}"</span>
                  </span>
                            </div>
                        </fieldset>
                    </form>
                </div>
                <div class="aside-footer">
                    <button type="button" class="btn btn-default" data-ng-click="cancelNewFile()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</script>

<div class="fade" ng-file-drop-available="setDropSupported()" ng-show="!dropSupported">
    <h4>
        HTML5 Drop File is not supported! You need an HTML5 compliant browser.
    </h4>
</div>
